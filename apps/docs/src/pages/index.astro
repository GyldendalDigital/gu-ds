---
import { AzureNamedKeyCredential, TableClient } from "@azure/data-tables";
import { AnimatedInput } from "../components/AnimatedInput";
import { Borders } from "../components/borders/Borders";
import { CategoryHeader } from "../components/categoryHeader/CategoryHeader";
import { Colors } from "../components/colors/Colors";
import { Elevation } from "../components/elevation/Elevation";
import { Sizes } from "../components/sizes/Sizes";
import { Typography } from "../components/typography/Typography";
import Layout from "../layouts/Layout.astro";

const save = async (value: string) => {
  const account = import.meta.env.AZURE_ACCOUNT;
  const accountKey = import.meta.env.AZURE_KEY;
  const tableName = "dsforslag";

  const credential = new AzureNamedKeyCredential(account, accountKey);
  const client = new TableClient(
    `https://${account}.table.core.windows.net`,
    tableName,
    credential
  );

  await client.createEntity({
    partitionKey: value,
    rowKey: new Date().toISOString(),
  });
};

let forslagCookie = Astro.cookies.get("forslag")?.value ?? "";

if (Astro.request.method === "POST") {
  try {
    const data = await Astro.request.formData();
    const name = `${data.get("name")}`;

    if (forslagCookie !== name) {
      await save(name);

      Astro.cookies.set("forslag", name);
      forslagCookie = name;
    }
    return Astro.redirect("/");
  } catch (error) {
    if (error instanceof Error) {
      console.error(error.message);
    }
  }
}
---

<Layout title="Designsystem X">
  <main>
    <h1>
      <form method="post">
        Velkommen til <AnimatedInput client:load initialValue={forslagCookie} />
        {
          !forslagCookie && (
            <button class="submit-button">Send inn forslag</button>
          )
        }
        <br />
      </form>
    </h1>
    {
      forslagCookie && (
        <div class="status">
          Forslag mottatt. <a href="/forslag">Se andre forslag</a>.
        </div>
      )
    }

    <div>
      <Colors client:idle />
      <Typography client:idle />
      <Sizes client:idle />
      <Borders client:idle />
      <Elevation client:idle />
    </div>
  </main>
</Layout>

<style>
  .status {
    text-align: center;
  }
  small {
    font-size: calc(var(--primitives-size-20) * 1px);
  }
</style>